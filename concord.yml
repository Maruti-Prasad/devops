configuration:
  runtime: "concord-v2"
  dependencies:
    - "mvn://org.codehaus.groovy:groovy-all:pom:2.5.23"

forms:
  myForm:
  - age: { label: "Age", type: "int", min: 21, max: 100 }
  - favouriteColour: { label: "Favourite colour", type: "string", allow: ["gray", "grey"], search: true }
  - password: { label: "Password", type: "string", inputType: "password" }

flows:
  default:
  - form: myForm
    saveSubmittedBy: true
  - log: "Hello, ${myForm.password}" 
  - log: "${datetime.format(datetime.current(), 'dd_MM_yyyy')}"
  - task: http
    in:
      method: GET
      headers:
        Authorization: "razE9gjB7xidAGT5jNYQIw"
      url: http://172.18.0.3:8001/api/v1/org/Default/secret
      ignoreErrors: false
      response: json
    out: response
  - set:
      secretNames: ${response.content.stream().map(s -> s.name).toList()}
  - log: "Secret names: ${secretNames}"    

  - form: secretSelectionForm
    fields:
      - selectedSecret:
          label: "Select a secret"
          type: "string"
          allow: ${secretNames}
        
  - log: "User selected: ${secretSelectionForm.selectedSecret}"              

  - task: http
    in:
      method: POST
      headers:
        Authorization: "Bearer razE9gjB7xidAGT5jNYQIw"
        Content-Type: "application/json"
      url: "http://172.18.0.3:8001/api/v1/org/Default/secret/${secretSelectionForm.selectedSecret}"
      ignoreErrors: false
      request: json
      response: json
      body: |
        {
            "name": "${secretSelectionForm.selectedSecret}_1"
        }
    out: response

  - task: http
    in:
      method: POST
      headers:
        Authorization: "Bearer razE9gjB7xidAGT5jNYQIw"
        Content-Type: "application/json"
      url: "http://172.18.0.3:8001/api/v1/org/Default/secret"
      ignoreErrors: false
      request: json
      response: json
      body: |
        {
          "name": "${secretSelectionForm.selectedSecret}",
          "type": "DATA",
          "visibility": "PRIVATE",
          "data": "${myForm.password}"
        }
    out: response

  - task: concordSecrets
    in:
      action: create
      name: test123
      visibility: "PRIVATE"
      data: anders-test-value
