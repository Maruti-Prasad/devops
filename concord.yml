configuration:
  runtime: "concord-v2"

forms:
  AcceptForm:
  - updatePassword: { label: "Accept for Password update job run", type: boolean }

flows:
  Akeyless:
  - form: AcceptForm
  - if: ${AcceptForm.updatePassword}
    then:
      - log: "[INFO] Accepted for Password update ..."
    else:
      - log: "[ERROR] Password update is not accepted ..."
      - exit

  - log: "${datetime.format(datetime.current(), 'dd_MM_yyyy')}"

  concord:
  - form: AcceptForm
  - if: ${AcceptForm.updatePassword}
    then:
      - log: "[INFO] Accepted for Password update ..."
    else:
      - log: "[ERROR] Password update is not accepted ..."
      - exit

  - log: "${datetime.format(datetime.current(), 'dd_MM_yyyy')}"


  - task: concordSecrets
    in:
      action: getAsString
      name: myNewSecretName_1
      ignoreErrors: false
    out: result
  - log: "Validate Result: ${result}"
  - if: ${result.status != "OK"}
    then:
      - throw: "myNewSecretName_1 'NOT_FOUND'"

  - log: "Update secret create"
  - task: concordSecrets
    in:
      action: update
      ignoreErrors: false
      name: myNewSecretName_2
      data: "${result.data}"
      createIfMissing: true

  - task: concordSecrets
    in:
      action: getAsString
      name: myNewSecretName_2
      ignoreErrors: false
    out: backup
  - log: "Validate Result: ${backup.data}"

  - task: http
    in:
      method: POST
      headers:
        Authorization: "Bearer razE9gjB7xidAGT5jNYQIw"
        Content-Type: "application/json"
      url: "http://172.18.0.4:8001/api/v1/org/Default/secret/${secretSelectionForm.selectedSecret}"
      ignoreErrors: false
      request: json
      response: json
      body: |
        {
            "name": "${secretSelectionForm.selectedSecret}_1"
        }
    out: response

  - task: concordSecrets
    in:
      action: create
      name: "${secretSelectionForm.selectedSecret}"
      visibility: "PRIVATE"
      data: anders-test-value
