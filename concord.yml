configuration:
  runtime: "concord-v2"

forms:
  AcceptForm:
  - updatePassword: { label: "Accept for Password update job run", type: boolean }

flows:
  Akeyless:
  - form: AcceptForm
  - if: ${AcceptForm.updatePassword}
    then:
      - log: "[INFO] Accepted for Password update ..."
    else:
      - log: "[ERROR] Password update is not accepted ..."
      - exit

  - log: "${datetime.format(datetime.current(), 'dd_MM_yyyy')}"

  default:
  - form: AcceptForm
  - if: ${AcceptForm.updatePassword}
    then:
      - log: "[INFO] Accepted for Password update ..."
    else:
      - log: "[ERROR] Password update is not accepted ..."
      - exit

  - log: "${datetime.format(datetime.current(), 'dd_MM_yyyy')}"
  - task: http
    in:
      method: GET
      headers:
        Authorization: "razE9gjB7xidAGT5jNYQIw"
      url: http://172.18.0.3:8001/api/v1/org/Default/secret
      ignoreErrors: false
      response: json
    out: response
  - set:
      secretNames: ${response.content.stream().map(s -> s.name).toList()}
  - log: "Secret names: ${secretNames}"    

  - form: secretSelectionForm
    fields:
      - selectedSecret:
          label: "Select a secret"
          type: "string"
          allow: ${secretNames}
      - passwordUpdate:
          label: "Create New Passowrd"
          type: "string"
          inputType: "password"

  - log: "User selected: ${secretSelectionForm.selectedSecret}"              

  - task: http
    in:
      method: POST
      headers:
        Authorization: "Bearer razE9gjB7xidAGT5jNYQIw"
        Content-Type: "application/json"
      url: "http://172.18.0.3:8001/api/v1/org/Default/secret/${secretSelectionForm.selectedSecret}"
      ignoreErrors: false
      request: json
      response: json
      body: |
        {
            "name": "${secretSelectionForm.selectedSecret}_1"
        }
    out: response

  - task: concordSecrets
    in:
      action: create
      name: "${secretSelectionForm.selectedSecret}"
      visibility: "PRIVATE"
      data: anders-test-value
